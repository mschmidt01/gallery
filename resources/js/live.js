const BLACK    = '#000000'
const NAVY     = '#000080'
const DARKBLUE 	= '#00008B'
const MEDIUMBLUE 	= '#0000CD'
const BLUE 	= '#0000FF'
const DARKGREEN 	 = '#006400'
const GREEN 	= '#008000'
const TEAL 	= '#008080'
const DARKCYAN 	= '#008B8B'
const DEEPSKYBLUE 	= '#00BFFF'
const DARKTURQUOISE 	= '#00CED1'
const MEDIUMSPRINGGREEN  =	'#00FA9A'
const LIME   = '#00FF00'
const SPRINGGREEN 	= '# 00FF7F'
const AQUA 	= '#00FFFF'
const CYAN 	= '#00FFFF'
const MIDNIGHTBLUE 	= '#191970'
const DODGERBLUE 	= '#1E90FF'
const LIGHTSEAGREEN 	= '#20B2AA'
const FORESTGREEN 	= '#228B22'
const SEAGREEN 	= '#2E8B57'
const DARKSLATEGRAY 	= '#2F4F4F'
const LIMEGREEN 	= '#32CD32'
const MEDIUMSEAGREEN 	= '#3CB371'
const TURQUOISE 	= '#40E0D0'
const ROYALBLUE 	= '#4169E1'
const STEELBLUE 	= '#4682B4'
const DARKSLATEBLUE 	= '#483D8B'
const MEDIUMTURQUOISE 	= '#48D1CC'
const INDIGO  	= '#4B0082'
const DARKOLIVEGREEN 	= '#556B2F'
const CADETBLUE 	= '#5F9EA0'
const CORNFLOWERBLUE 	= '#6495ED'
const REBECCAPURPLE 	= '#663399'
const MEDIUMAQUAMARINE 	= '#66CDAA'
const DIMGRAY 	= '#696969'
const SLATEBLUE 	= '#6A5ACD'
const OLIVEDRAB 	= '#6B8E23'
const SLATEGRAY 	= '#708090'
const LIGHTSLATEGRAY 	= '#778899'
const MEDIUMSLATEBLUE 	= '#7B68EE'
const LAWNGREEN 	= '#7CFC00'
const CHARTREUSE 	= '#7FFF00'
const AQUAMARINE 	= '#7FFFD4'
const MAROON 	= '#800000'
const PURPLE 	= '#800080'
const OLIVE 	= '#808000'
const GRAY 	= '#808080'
const SKYBLUE 	= '#87CEEB'
const LIGHTSKYBLUE 	= '#87CEFA'
const BLUEVIOLET 	= '#8A2BE2'
const DARKRED 	= '#8B0000'
const DARKMAGENTA 	= '#8B008B'
const SADDLEBROWN 	= '#8B4513'
const DARKSEAGREEN 	= '#8FBC8F'
const LIGHTGREEN 	= '#90EE90'
const MEDIUMPURPLE 	= '#9370DB'
const DARKVIOLET 	= '#9400D3'
const PALEGREEN 	= '#98FB98'
const DARKORCHID 	= '#9932CC'
const YELLOWGREEN 	= '#9ACD32'
const SIENNA 	= '#A0522D'
const BROWN 	= '#A52A2A'
const DARKGRAY 	= '#A9A9A9'
const LIGHTBLUE 	= '#ADD8E6'
const GREENYELLOW 	= '#ADFF2F'
const PALETURQUOISE 	= '#AFEEEE'
const LIGHTSTEELBLUE 	= '#B0C4DE'
const POWDERBLUE 	= '#B0E0E6'
const FIREBRICK 	= '#B22222'
const DARKGOLDENROD 	= '#B8860B'
const MEDIUMORCHID 	= '#BA55D3'
const ROSYBROWN 	= '#BC8F8F'
const DARKKHAKI 	= '#BDB76B'
const SILVER 	= '#C0C0C0'
const MEDIUMVIOLETRED 	= '#C71585'
const INDIANRED  	= '#CD5C5C'
const PERU 	= '#CD853F'
const CHOCOLATE 	= '#D2691E'
const TAN 	= '#D2B48C'
const LIGHTGRAY 	= '#D3D3D3'
const THISTLE 	= '#D8BFD8'
const ORCHID 	= '#DA70D6'
const GOLDENROD 	= '#DAA520'
const PALEVIOLETRED 	= '#DB7093'
const CRIMSON 	= '#DC143C'
const GAINSBORO 	= '#DCDCDC'
const PLUM 	= '#DDA0DD'
const BURLYWOOD 	= '#DEB887'
const LIGHTCYAN 	= '#E0FFFF'
const LAVENDER 	= '#E6E6FA'
const DARKSALMON 	= '#E9967A'
const VIOLET 	= '#EE82EE'
const PALEGOLDENROD 	= '#EEE8AA'
const LIGHTCORAL 	= '#F08080'
const KHAKI 	= '#F0E68C'
const ALICEBLUE 	= '#F0F8FF'
const HONEYDEW 	= '#F0FFF0'
const AZURE 	= '#F0FFFF'
const SANDYBROWN 	= '#F4A460'
const WHEAT 	= '#F5DEB3'
const BEIGE 	= '#F5F5DC'
const WHITESMOKE 	= '#F5F5F5'
const MINTCREAM 	= '#F5FFFA'
const GHOSTWHITE 	= '#F8F8FF'
const SALMON 	= '#FA8072'
const ANTIQUEWHITE 	= '#FAEBD7'
const LINEN 	= '#FAF0E6'
const LIGHTGOLDENRODYELLOW 	= '#FAFAD2'
const OLDLACE 	= '#FDF5E6'
const RED 	= '#FF0000'
const FUCHSIA 	= '#FF00FF'
const MAGENTA 	= '#FF00FF'
const DEEPPINK 	= '#FF1493'
const ORANGERED 	= '#FF4500'
const TOMATO 	= '#FF6347'
const HOTPINK 	= '#FF69B4'
const CORAL 	= '#FF7F50'
const DARKORANGE 	= '#FF8C00'
const LIGHTSALMON 	= '#FFA07A'
const ORANGE 	= '#FFA500'
const LIGHTPINK 	= '#FFB6C1'
const PINK 	= '#FFC0CB'
const GOLD 	= '#FFD700'
const PEACHPUFF 	= '#FFDAB9'
const NAVAJOWHITE 	= '#FFDEAD'
const MOCCASIN 	= '#FFE4B5'
const BISQUE 	= '#FFE4C4'
const MISTYROSE 	= '#FFE4E1'
const BLANCHEDALMOND 	= '#FFEBCD'
const PAPAYAWHIP 	= '#FFEFD5'
const LAVENDERBLUSH 	= '#FFF0F5'
const SEASHELL 	= '#FFF5EE'
const CORNSILK 	= '#FFF8DC'
const LEMONCHIFFON 	= '#FFFACD'
const FLORALWHITE 	= '#FFFAF0'
const SNOW 	= '#FFFAFA'
const YELLOW 	= '#FFFF00'
const LIGHTYELLOW 	= '#FFFFE0'
const IVORY 	= '#FFFFF0'
const WHITE 	= '#FFFFFF'

var xmin = 0
var xmax = 1
var ymin = 0
var ymax = 1

var width = 500
var height = 500
var canvasLeft
var canvasTop
var ctx
var border = 5
var columns = 8
var rows = 8
var barWidth = 0.4
var symbols = []
var numberingFlag = false
var logView;

global.textColor = '#000000';
global.xmax = xmax
global.ymax = ymax
global.xmin = xmin
global.ymin = ymin
global.width = width
global.height = height
global.canvasLeft = canvasLeft
global.canvasTop = canvasTop
global.ctx = ctx
global.border = border
global.columns = columns
global.rows = rows
global.barWidth =barWidth
global.symbols = symbols
global.numberingFlag = numberingFlag
global.logView = logView;


 function punkt( x, y ) {
    this.x = x;
    this.y = y;

    this.trans =  function() {
        var yfactor = (global.height-2*global.border) / (global.ymax-global.ymin);
        var xfactor = global.width / (global.xmax-global.xmin);
        var yg = global.height - global.border - (y - global.ymin) * yfactor;
        var xg = (x-global.xmin) * xfactor;
        //console.log( y + " -> " + yg )
        return  new punkt( xg, yg )
    }
}

function Symbol( x, y ) {
    this.x = x;
    this.y = y;
    this.size  = 0.45
    this.color = '#c0c0c0';
    this.textColor = global.textColor;
    this.type  = "c"
    this.text  = ""

    this.getDataSet = function() {
        var plotter = new dataSet( "d-" + this.x +  this.y)

        switch( this.type ) {
            case "c":
                for (var t = 0; t < 2 * Math.PI; t += 0.03) {
                    var xx = this.x + this.size * Math.cos(t);
                    var yy = this.y + this.size * Math.sin(t);
                    plotter.add(xx, yy);
                }
                break;
            case "d":
                plotter.add(this.x - this.size, this.y);
                plotter.addD(this.size, -this.size);
                plotter.addD(this.size, +this.size);
                plotter.addD(-this.size, this.size);
                plotter.addD( -this.size, -this.size);
                break
            case "s":
                plotter.add(this.x - this.size, this.y - this.size);
                plotter.addD(2 * this.size, 0);
                plotter.addD(0, 2 * this.size);
                plotter.addD(-2 * this.size, 0);
                plotter.addD(0, -2 * this.size);
                break

            case "*":
                var spitzen = 8;
                var phi = 2 * Math.PI / spitzen;
                var radius1 = 0.4 * this.size;
                for (var t = -phi / 4; t < 2 * Math.PI; t += phi) {
                    var xx = this.x + radius1 * Math.cos(t);
                    var yy = this.y + radius1 * Math.sin(t);
                    plotter.add(xx, yy);
                    xx = this.x + this.size * Math.cos(t + phi / 2.);
                    yy = this.y + this.size * Math.sin(t + phi / 2.);
                    plotter.add(xx, yy);
                }
                var xx = radius1 + this.x;
                var yy = this.y;
                plotter.add(xx, yy);
                break
            case "b":
                plotter.add( this.x - global.barWidth, this.y - 0.5);
                plotter.addD( 0, 2 * this.size);
                plotter.addD( 2 * global.barWidth, 0);
                plotter.addD( 0, -2 * this.size);
                plotter.addD( -2 * global.barWidth, 0);
                break
            case "none":
                break
            default:
                console.log(  "Symboltyp " + this.type + " (noch) nicht implementiert")

        }
        return plotter
    }

    this.update = function() {
        this.dataSet = this.getDataSet()
        this.dataSet.malen( this.color)
        var text = this.text
        if( global.numberingFlag & text == "" ) {
            text = x+","+y
        }
        if( text != "" ) {
            var c1 = new punkt( this.x, this.y)
            var c1t = c1.trans()
            global.ctx.font = "14px Arial";
            global.ctx.textAlign = "center";
            global.ctx.fillStyle = this.textColor;
            global.ctx.fillText( text, c1t.x, c1t.y)
        }
    }

    this.clear = function() {
        var c1 = new punkt( this.x-0.5, this.y-0.5)
        var c2 = new punkt( this.x+0.5, this.y+0.5)
        var c1t = c1.trans()
        var c2t = c2.trans()
        //console.log( "clear " +  c1t.x + " " +  c1t.y + " " +  (c2t.x-c1t.x) + " " + ( c1t.y-c2t.y) )
        global.ctx.clearRect( c1t.x, c2t.y, c2t.x-c1t.x, c1t.y-c2t.y)
        return this
    }
    this.update()
}

function infotext() {
    return " x: [" + global.xmin.toPrecision(3) +"," + global.xmax.toPrecision(3) + "]"
        + " y: [" + global.ymin.toPrecision(3) +"," + global.ymax.toPrecision(3) + "]"
}

function  dataSet( name )   {
    this.name   = name
    this.punkte = new Array()

    this.text   = function() {
        return this.name + " x: [" + global.xmin.toPrecision(3) +"," + global.xmax.toPrecision(3) + "]"
            + " y: [" + global.ymin.toPrecision(3) +"," + global.ymax.toPrecision(3) + "]"
    }
    this.add    = function( x, y) {
        this.punkte.push( new punkt( x, y ) )
        global.xmax = Math.max( global.xmax, x)
        global.xmin = Math.min( global.xmin, x)
        global.ymax = Math.max( global.ymax, y)
        global.ymin = Math.min( global.ymin, y)

    }
    this.addD    = function( x, y ) {
        var last = this.punkte.slice(-1)[0]
        this.add( last.x + x, last.y + y )

    }
    this.malen = function( color ) {
        if( this.punkte.length == 0 ) {
            return
        }
        global.ctx.lineWidth=2;
        global.ctx.fillStyle = color;
        //console.log( "color: " + ctx.fillStyle )
        global.ctx.beginPath();

        var drawPoint = this.punkte[0].trans()
        global.ctx.moveTo( drawPoint.x, drawPoint.y)
        for( var i=1; i<this.punkte.length; i++ ) {
            var drawPoint = this.punkte[i].trans()
            global.ctx.lineTo( drawPoint.x, drawPoint.y)
        }
        global.ctx.stroke()
        global.ctx.closePath();
        global.ctx.fill();
    }
}

function clearSymbol(x, y ) {
    var c1 = new punkt( x-0.5, y-0.5)
    var c2 = new punkt( x+0.5, y+0.5)
    var c1t = c1.trans()
    var c2t = c2.trans()
    //console.log( "clear " +  c1t.x + " " +  c1t.y + " " +  (c2t.x-c1t.x) + " " + ( c1t.y-c2t.y) )
    global.ctx.clearRect( Math.round(c1t.x), Math.round(c2t.y), Math.round(c2t.x-c1t.x), Math.round(c1t.y-c2t.y) )
}

export  function numbering( ) {
    global.numberingFlag = ! global.numberingFlag
    global.symbols.forEach( function(s) {
        s.clear().update();
    })
}

 function statusText( text) {
    document.getElementById("titel").innerHTML=text;
}

 function text2(x, y, text) {
    var ind = index(x,y)
    global.symbols[ind].text = text
    global.symbols[ind].update()
}

function farben(c) {
    for( var x=0; x<global.columns; x++ ) {
        for( var y=0; y<global.rows; y++ ) {
            farbe2( x, y, c);
        }
    }
}
function farbe2(x, y , c) {
    var ind = index(x,y)
    global.symbols[ind].color = c;
    //symbols[ind].clear()
    global.symbols[ind].update()
}

function textFarbe2(x, y , c) {
    var ind = index(x,y)
    global.symbols[ind].textColor = c;
    //symbols[ind].clear()
    global.symbols[ind].update()
}

function form2(x, y , c) {
    var ind = index(x,y)
    console.log( ind )
    console.log( "rs" )
    global.symbols[ind].type = c;
    global.symbols[ind].clear().update()
}

function symbolGroesse2(x, y, s) {
    var ind = index(x,y)
    global.symbols[ind].size = s;
    global.symbols[ind].clear().update()
}

function formen(type) {
    for( var x=0; x<global.columns; x++ ) {
        for( var y=0; y<global.rows; y++ ) {
            form2( x, y, type);
        }
    }
}


function index( x, y ) {
    var ind =  x + y * global.columns
    if( x >= global.columns | y >= global.rows  | x < 0 | y < 0) {
        var e = new Error();
        var m = e.stack.match(/ymous>:[0-9]+/)
        var parts = m[0].split(":")
        console.log( ">>" + parts[1]);

        throw new RangeError( "Out of range: ("+x+","+y+") line " + parts[1] )
    }
    return ind
}

function groesse( c, r ) {
    global.columns = c
    global.rows = r
    clearAll();
    board()
}

function clearAll() {
    while (global.symbols.length > 0) {
        global.symbols.pop()
    }
    clearCanvas()
}


export function board( ) {
     global.xmin = -1
     global.ymin = -1
     global.xmax = global.columns
     global.ymax  = global.rows
    //console.log( "in board() ")
    for( var x=0; x<global.columns; x++ ) {
        for( var y=0; y<global.rows; y++ ) {
            var ind = index(x,y)
            global.symbols[ind] = new Symbol( x, y )
            //form2( x, y, "c");
            //console.log( ind + " " + symbols[ind].dataSet.name)
        }
    }
    console.log( infotext() )
    document.getElementById("titel").innerHTML=infotext();

}

export function runCode(editor) {
    console.log( "run code " )
    global.logView.innerHTML = ""

    //var code = document.getElementById("codeView").value
    eval( editor.getValue() )
}

function runJava() {
    console.log( "run java code " )
    logView.innerHTML = ""

    var code = document.getElementById("codeView").value
    var fcts = []
    $.post("api.php", {action:"compile", code:code }, function(data){
        alert("Data: " + data);
        var lines = JSON.parse( data )
        for(  var i in lines ) {
            if( lines[i].indexOf(">>") == 0 ) {
                eval( lines[i].slice( 3 ) )
            } else {
                logView.innerHTML += lines[i] + "<br>"
            }
        }
    })
}

export function download(text, name, type) {
    var a = document.createElement("a");
    var file = new Blob([text], {type: type});
    a.href = URL.createObjectURL(file);
    a.download = name;
    a.click();
}

export function saveCode(fileName,editor) {
    console.log( "save code " )
    global.logView = document.getElementById("consoleLog");
    if( fileName === "" ) {
        global.logView.innerHTML =  'Bitte Dateiname  angeben'
        return

    }
    download( editor.getValue(), fileName, 'text/plain');
    global.logView.innerHTML = ""
}

export function clearCanvas() {
    console.log( "clear canvas" )
    global.ctx.beginPath();
    global.ctx.clearRect( 0, 0, global.width, global.height)
}

function flaeche( c ) {
    console.log( "fill canvas" )
    var canvas = document.getElementById("myCanvas");
    canvas.style.background = c;
    //ctx.FillRect( 0, 0, width, height)

}
function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

